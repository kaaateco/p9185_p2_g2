---
title: "kate_analysis"
author: "Kate Colvin"
date: "2026-02-13"
output: pdf_document
---
  
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(ggplot2)
library(gtsummary)
library(gridExtra)
library(ggridges)
library(maps)
library(gt)
library(tigris)
library(sf)
library(purrr)

```

Loading in data

```{r}

tract <- read_csv("tract_cbsa.csv") %>% 
  mutate(dens_mult = dens*1000000)
tract

```

Summary Table(s)

```{r}

table1 <- tract %>% 
  tbl_summary(include = c(pm25, hyads, bc, total, dens_mult, pct_pov, 
                          pct_white, pct_black, pct_asian, pct_hispanic),
              by = ruca_agg, 
              label = list(
                pm25 ~ "PM 2.5",
                hyads ~ "Coal Power Plant Impact (HyADS)",
                bc ~ "Black Carbon",
              #  area ~ "Land Area (m)",
                total ~ "Total Population",
                dens_mult ~ "Population Density (per km^2)",
                pct_pov ~ "Percent in Poverty (%)",
                pct_white ~ "Percent White (%)",
                pct_black ~ "Percent Black (%)",
                pct_asian ~ "Percent Asian (%)",
                pct_hispanic ~ "Percent Hispanic (%)"),
             # statistic = all_continuous() ~ "{mean} ({sd})",
              digits = all_continuous() ~ 2, 
              missing = "no") %>% 
  add_p() %>% 
  add_overall() %>% 
  bold_labels() %>% 
  modify_caption("**Table 1**: Census Tract Characteristics, by RUCA Categorization")

table1

table1 <- table1 %>% as_gt()
gtsave(table1, "results/table1.png")

```

Visualizations 

```{r}

# Long format race data
race_long <- tract %>%
  select(pct_white, pct_black, pct_asian, pct_hispanic, pm25, ruca, ruca_agg) %>%
  pivot_longer(
    cols = starts_with("pct"),
    names_to = "race",
    values_to = "percent") %>% 
  mutate(race = recode(race,
                       pct_white = "White",
                       pct_black = "Black",
                       pct_asian = "Asian",
                       pct_hispanic = "Hispanic"))

```

Basic histograms
```{r, eval = FALSE}

# Distribution of PM 2.5

tract %>% 
  ggplot(aes(x = pm25)) +
  geom_histogram(fill = "navy", bins = 40) +
  theme_minimal() +
  labs(title = "Distribution of PM2.5",
       x = "PM2.5",
       y = "Count")

```

```{r, eval = FALSE}

# Long format race data
race_long <- tract %>%
  select(pct_white, pct_black, pct_asian, pct_hispanic, pm25) %>%
  pivot_longer(
    cols = starts_with("pct"),
    names_to = "race",
    values_to = "percent") %>% 
  mutate(race = recode(race,
                       pct_white = "White",
                       pct_black = "Black",
                       pct_asian = "Asian",
                       pct_hispanic = "Hispanic"))

race_long %>% 
  ggplot(aes(x = percent)) +
  geom_density(fill = "navy", alpha = 0.6) +
  facet_wrap(~ race, ncol = 2) +
  theme_minimal() +
  labs(x = "Percent of Census Tract Population",
       y = "Density",
       title = "Distribution of Racial/Ethnic Composition Across Census Tracts")


```

Many tracts are mostly white; uneven distribution of minority groups (close to 0% for most tracts, with a small share of tracts having a high percentage of hispanic/black residents). 

Gradient histogram
```{r, eval = FALSE}

# Gradient boxplot

bin_width <- 1

tract_2 <- tract %>% na.omit() %>% 
  mutate(bin = cut(pm25,
                   breaks = seq(floor(min(pm25)),
                                ceiling(max(pm25)),
                                by = bin_width),
                   include.lowest = TRUE)) %>%
  group_by(bin) %>%
  arrange(desc(pct_white), .by_group = TRUE) %>%
  mutate(stack_id = row_number()) %>%
  ungroup()

ggplot(tract_2, aes(x = bin,
                y = 1,
                fill = pct_white,
                group = stack_id)) +
  geom_bar(stat = "identity") +
  scale_fill_gradient(low = "red", high = "blue") +
  theme_minimal() +
  labs(x = "PM2.5",
       y = "Number of Census Tracts",
       fill = "% White")

```

## Figure 1

```{r}
  
tract_ridges <- tract %>%
   filter(!is.na(pm25), !is.na(pct_white)) %>%
   mutate(
     white_group = ntile(pct_white, 5),
     white_group = factor(
       white_group,
       levels = 1:5,
       labels = c("0-20%", 
                  "20-40%",
                  "40-60%",
                  "60-80%", 
                  "80-100%")))

figure1 <- tract_ridges %>% ggplot(aes(x = pm25, y = white_group, fill = white_group)) +
   geom_density_ridges(
     alpha = 0.85,
     scale = 1.2,
     color = "white") +
   theme_minimal() +
   labs(
     x = expression(PM[2.5]~"Concentration (µg/m"^3*")"),
     y = "% White",
     title = "Distribution of PM2.5 by % of White Census Tract Population") +
   theme(legend.position = "none", 
         plot.title = element_text(size = 12))

# figure1

# ggsave(filename = "results/figure1.png", plot = figure1, 
 #       width = 8, height = 5, dpi = 300)

```

```{r}

tract_ridges <- tract %>%
   filter(!is.na(bc), !is.na(pct_white)) %>%
   mutate(
     white_group = ntile(pct_white, 5),
     white_group = factor(
       white_group,
       levels = 1:5,
       labels = c("0-20%", 
                  "20-40%",
                  "40-60%",
                  "60-80%", 
                  "80-100%")))

figure_bc <- tract_ridges %>% ggplot(aes(x = bc, y = white_group, fill = white_group)) +
   geom_density_ridges(
     alpha = 0.85,
     scale = 1.2,
     color = "white") +
   theme_minimal() +
   labs(
     x = "Total Black Carbon Concentration",
     y = "% White",
     title = "Distribution of Black Carbon Concentration by % of White Census Tract Population") +
   theme(legend.position = "none", 
         plot.title = element_text(size = 12))

```

```{r}

# HyADS 

tract_ridges <- tract %>%
   filter(!is.na(hyads), !is.na(pct_white)) %>%
   mutate(
     white_group = ntile(pct_white, 5),
     white_group = factor(
       white_group,
       levels = 1:5,
       labels = c("0-20%", 
                  "20-40%",
                  "40-60%",
                  "60-80%", 
                  "80-100%")))

figure_hyads <- tract_ridges %>% ggplot(aes(x = hyads, y = white_group, fill = white_group)) +
   geom_density_ridges(
     alpha = 0.85,
     scale = 1.2,
     color = "white") +
   theme_minimal() +
   labs(
     x = "HyADS (Impact of Coal-Fired Power Plants)",
     y = "% White",
     title = "Distribution of HyADS by % of White Census Tract Population") +
   theme(legend.position = "none", 
         plot.title = element_text(size = 12))

figure_hyads

ggsave(filename = "results/figure_hyads.png", plot = figure_hyads, 
       width = 8, height = 5, dpi = 300)

```

```{r}

figure1_combined <- grid.arrange(figure1, figure_bc, figure_hyads, nrow = 3)
figure1_combined

ggsave(filename = "results/figure1_combined.png", plot = figure1_combined, 
       width = 8, height = 11, dpi = 300)

```


## Figure 2

Wyoming and Massachusetts are missing. 

```{r}

# Fixing names
state_lookup <- tibble(
  state_abb = state.abb,
  region = tolower(state.name))

# State means
state_summary <- tract %>%
  group_by(state_abb) %>%
  summarise(mean_pm = mean(pm25, na.rm = TRUE)) %>%
  left_join(state_lookup, by = "state_abb")

states_map <- map_data("state")
map_df <- states_map %>%
  left_join(state_summary, by = "region")

map_1 <- ggplot(map_df, aes(long, lat, group = group, fill = mean_pm)) +
  geom_polygon(color = "white", size = 0.2) +
  coord_fixed(1.3) +
#  scale_fill_gradient(low = "blue", high = "red") +
  scale_fill_viridis_c(option = "viridis", na.value = "grey90") +
  theme_void() +
  labs(fill = "PM2.5",
       title = "Mean PM2.5 by State") +
  theme(plot.title = element_text(size = 12))

map_1

```

```{r}

state_white <- 
  tract %>%
  group_by(state_abb) %>%
  summarise(
    total_pop = sum(total, na.rm = TRUE),
    total_white = sum(count_white, na.rm = TRUE),
    pct_white_state = 100 * total_white / total_pop)

state_white <- state_white %>%
  left_join(state_lookup, by = "state_abb")

map_df <- states_map %>%
  left_join(state_white, by = "region")

map_2 <- ggplot(map_df, aes(long, lat, group = group, fill = pct_white_state)) +
  geom_polygon(color = "white", linewidth = 0.2) +
  coord_fixed(1.3) +
  # scale_fill_gradient(low = "red", high = "blue") +
  scale_fill_viridis_c(option = "viridis", na.value = "grey90") +
  theme_void() +
  labs(fill = "% White",
       title = "% White Population by State") +
  theme(plot.title = element_text(size = 12))


```

```{r}

# options(tigris_use_cache = TRUE)

# states <- unique(tract$state_abb)
# tract_shapes <- map_dfr(
#   states,
#   ~ tracts(state = .x, year = 2010, class = "sf")) %>%
#   st_transform(4326)

# saveRDS(tract_shapes, "tract_shapes_2010_us.rds")

tract_shapes <- readRDS("tract_shapes_2010_us.rds")

tract_map <- tract_shapes %>%
  left_join(tract, by = c("GEOID10" = "geoid"))

map_3 <- ggplot(tract_map) +
  geom_sf(aes(fill = pm25), color = NA) +
 # scale_fill_gradient(low = "blue", high = "red", na.value = "grey90") +
  scale_fill_viridis_c(option = "viridis", na.value = "grey90") + 
  theme_void() +
  labs(
    fill = "PM2.5",
    title = "PM2.5 by Census Tract") +
  theme(plot.title = element_text(size = 12))

map_3

```

```{r}

map_4 <- ggplot(tract_map) +
  geom_sf(aes(fill = pct_white), color = NA) +
 # scale_fill_gradient(low = "red", high = "blue", na.value = "grey90") +
  scale_fill_viridis_c(option = "viridis", na.value = "grey90") +
  theme_void() +
  labs(
    fill = "% White",
    title = "% White Population by Census Tract") +
  theme(plot.title = element_text(size = 12))

map_4

```

```{r}

figure2 <- grid.arrange(map_1, map_3, map_2, map_4, nrow = 2)

ggsave(filename = "results/figure2.png", plot = figure2, 
       width = 8, height = 5, dpi = 300)

```


## Figure 3

```{r}

figure3 <- race_long %>% 
  ggplot(aes(x = percent, y = pm25, color = race)) +
  geom_point(alpha = 0.3) +
  geom_smooth(color = "black") +
  facet_wrap(~race) +
  theme_minimal() +
  labs(title = "PM2.5 vs. of % of Census Tract Population",
       x = "% of Census Tract Population",
       y = PM[2.5]~"Concentration (µg/m"^3*")") +
  theme(plot.title = element_text(size = 12))

figure3

ggsave(filename = "results/figure3.png", plot = figure3, 
       width = 8, height = 5, dpi = 300)

```


## Figure 4

RUCA Graphs

```{r}

ruca_1 <- tract %>% ggplot(aes(x = pm25, y = ruca_agg, fill = ruca_agg)) +
   geom_density_ridges(
     alpha = 0.85,
     scale = 1.2,
     color = "white") +
   theme_minimal() +
   labs(
     x = expression(PM[2.5]~"Concentration (µg/m"^3*")"),
     y = "RUCA",
     title = "Distribution of PM2.5 by Aggregated Rural-Urban Commuting Area") +
   theme(legend.position = "none", 
         plot.title = element_text(size = 12))

ruca_2 <- tract %>% ggplot(aes(x = factor(ruca), y = pm25, color = factor(ruca))) +
  geom_boxplot() +
  theme_minimal() + 
  labs(
     x = "RUCA Code",
     y = expression(PM[2.5]~"Concentration (µg/m"^3*")"),
     title = "Distribution of PM2.5 by Rural-Urban Commuting Area Code") +
   theme(legend.position = "none", 
         plot.title = element_text(size = 12))

ruca_arrange <- grid.arrange(ruca_1, ruca_2, nrow = 2)
ruca_arrange

ggsave(filename = "results/figure4.png", plot = ruca_arrange, 
       width = 8, height = 5, dpi = 300)

```


## Figure 5

Comparing RUCA to % White

```{r}

figure5 <- tract %>% ggplot(aes(x = pct_white, y = ruca_agg, fill = ruca_agg)) +
   geom_density_ridges(
     alpha = 0.85,
     scale = 1.2,
     color = "white") +
   theme_minimal() +
   labs(
     x = "% White",
     y = "RUCA",
     title = "Distribution of % White Census Tracts by Rural-Urban Commuting Area Code") +
   theme(legend.position = "none", 
         plot.title = element_text(size = 12))

figure5

# ruca_4 <- tract %>% ggplot(aes(x = factor(ruca), y = pct_white, color = factor(ruca))) +
#  geom_boxplot() +
#  theme_minimal() + 
#  labs(
#     x = "RUCA Code",
#     y = "% White",
#     title = "Distribution of % White Census Tracts by Rural-Urban Commuting Area Code") +
#   theme(legend.position = "none", 
#         plot.title = element_text(size = 12))

# ruca_arrange_white <- grid.arrange(ruca_3, ruca_4, nrow = 2)
# ruca_arrange_white

ggsave(filename = "results/figure5.png", plot = figure5, 
       width = 8, height = 5, dpi = 300)

```


## HyADS and Black Carbon as outcomes 

```{r}

# HyADS 

tract_ridges <- tract %>%
   filter(!is.na(hyads), !is.na(pct_white)) %>%
   mutate(
     white_group = ntile(pct_white, 5),
     white_group = factor(
       white_group,
       levels = 1:5,
       labels = c("0-20%", 
                  "20-40%",
                  "40-60%",
                  "60-80%", 
                  "80-100%")))

figure_hyads <- tract_ridges %>% ggplot(aes(x = hyads, y = white_group, fill = white_group)) +
   geom_density_ridges(
     alpha = 0.85,
     scale = 1.2,
     color = "white") +
   theme_minimal() +
   labs(
     x = "HyADS (Impact of Coal-Fired Power Plants)",
     y = "% White",
     title = "Distribution of HyADS by % of White Census Tract Population") +
   theme(legend.position = "none", 
         plot.title = element_text(size = 12))

figure_hyads

ggsave(filename = "results/figure_hyads.png", plot = figure_hyads, 
       width = 8, height = 5, dpi = 300)

```

```{r}

tract_ridges <- tract %>%
   filter(!is.na(bc), !is.na(pct_white)) %>%
   mutate(
     white_group = ntile(pct_white, 5),
     white_group = factor(
       white_group,
       levels = 1:5,
       labels = c("0-20%", 
                  "20-40%",
                  "40-60%",
                  "60-80%", 
                  "80-100%")))

figure_bc <- tract_ridges %>% ggplot(aes(x = bc, y = white_group, fill = white_group)) +
   geom_density_ridges(
     alpha = 0.85,
     scale = 1.2,
     color = "white") +
   theme_minimal() +
   labs(
     x = "Total Black Carbon Concentration",
     y = "% White",
     title = "Distribution of Black Carbon Concentration by % of White Census Tract Population") +
   theme(legend.position = "none", 
         plot.title = element_text(size = 12))

# figure_bc

# ggsave(filename = "results/figure_bc.png", plot = figure_bc, 
#        width = 8, height = 5, dpi = 300)

```


## Bar plot she suggested; racial groups per percentile of PM2.5 exposure 

```{r}

pm_long <- race_long %>%
  filter(!is.na(pm25)) %>% 
  mutate(pm25_percentile = ntile(pm25, 5)) %>% 
  mutate(pm25_percentile = factor(
    pm25_percentile,
       levels = 1:5,
       labels = c("0-20%", 
                  "20-40%",
                  "40-60%",
                  "60-80%", 
                  "80-100%")))

figure_pm_bar <- ggplot(pm_long, aes(x = factor(pm25_percentile),
                 y = percent,
                 fill = race)) +
  geom_bar(stat = "identity", position = "stack") +
  # facet_wrap(~ ruca_agg) +
  labs(x = "PM2.5 Percentile",
       y = "Proportion",
       fill = "Race",
       title = "Racial Composition by PM2.5 Exposure Percentile") +
  theme_minimal() +
  theme(plot.title = element_text(size = 12))

figure_pm_bar

ggsave(filename = "results/figure_pm_bar.png", plot = figure_pm_bar, 
        width = 8, height = 5, dpi = 300)

```

